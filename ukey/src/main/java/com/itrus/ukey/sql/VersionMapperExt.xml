<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itrus.ukey.db.VersionMapper">
    <resultMap id="ProVerRetMap" type="com.itrus.ukey.sql.ProjectVersionInfo">
        <result column="project" jdbcType="BIGINT" property="project" />
        <result column="product" jdbcType="BIGINT" property="product" />
        <result column="vid" jdbcType="BIGINT" property="versionId" />
        <result column="pro_ver_fix" jdbcType="VARCHAR" property="proVerFix" />
        <result column="min_ver_fix" jdbcType="VARCHAR" property="minVerFix" />
        <result column="max_ver_fix" jdbcType="VARCHAR" property="maxVerFix" />
    </resultMap>
  <select id="selectValidByExample" parameterType="com.itrus.ukey.db.VersionExample" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    <if test="distinct">
      distinct
    </if>
    <include refid="Base_Column_List" />
    from version
    where status ='valid'
    <if test="orderByClause != null">
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectMaxIdByProject" parameterType="java.lang.Long" resultType="long">
  	SELECT 
  		MAX(v.id) 
  	FROM 
  		version v JOIN project_version pv 
  	ON 
  		v.id=pv.product_version 
  	where 
  		pv.project=#{projectId,jdbcType=BIGINT} and v.status='valid'  
  	GROUP BY v.product
  </select>
  <select id="selectPushByProject" parameterType="java.lang.Long" resultType="long">
  	SELECT 
  		v.product 
  	FROM 
  		version v JOIN project_version pv 
  	ON 
  		v.id=pv.product_version 
  	where 
  		pv.project=#{projectId,jdbcType=BIGINT} and pv.is_push=TRUE  
  	GROUP BY v.product
  </select>
  <select id="selectProductMaxVer" resultMap="BaseResultMap">
	SELECT
		v.id,
		v.create_time,
		v.product,
		v.product_version,
		v.product_version_fix
	FROM
		version v,
		(
		SELECT
			MAX(DISTINCT product_version_fix)AS product_version_fix,
			product
		FROM
			version
		WHERE
			status = 'valid'
		GROUP BY
			product
		) max_ver
	WHERE
		v.product_version_fix = max_ver.product_version_fix
	AND v.product = max_ver.product
	GROUP BY
		product;
  </select>
    <select id="selectProVers" resultMap="ProVerRetMap">
        SELECT
          pv.project,
          v.product,
          v.id as vid,
          v.product_version_fix as pro_ver_fix,
          pv.min_version_fix as min_ver_fix,
          pv.max_version_fix as max_ver_fix
        from
          version v JOIN project_version pv ON v.id=pv.product_version
        WHERE
          v.status='valid'
        ORDER BY
          product_version_fix desc;
    </select>
</mapper>